#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/mman.h>
#include <sys/types.h>

void garnir(char zone[], int lg, char motif) {
	int ind;
	for (ind=0; ind<lg; ind++) {
		zone[ind] = motif ;
	}
}

void lister(char zone[], int lg) {
	int ind;
	for (ind=0; ind<lg; ind++) {
		printf("%c",zone[ind]);
	}
	printf("\n");
}

int main(int argc,char *argv[]) {
	int taillepage = sysconf(_SC_PAGESIZE);
	int fd=open("Temporaire",O_CREAT|O_TRUNC|O_WRONLY);
	/**Couplage du segment de taille 2 pages au fichier en mode partageable*/
    char *buf=mmap(fd,3*taillepage,PROT_READ|PROT_WRITE,MAP_ANON|MAP_SHARED,-1,0);
	garnir(buf,taillepage,'a');
	
	if (fd < 0) {
        printf("Erreur ouverture") ;
    exit(1) ;
     }
	
	write(fd,buf,taillepage);
	close(fd);
	
	/**Creer un processus fils*/
    int pid=fork();
    if(pid<0){
        printf("erreur du fork");
        exit(EXIT_FAILURE);
    }
    /**Fils*/
	else if(pid==0){
        /**recouplage en mode privé*/
        char *buf=mmap(fd,3*taillepage,PROT_READ|PROT_WRITE,MAP_ANON|MAP_PRIVATE,-1,0);
        /**lister les 10 premiers octets de la 1ère page*/
        lister(buf,10);
		sleep(4);
		/**Lister les 10 premiers octets des pages*/
        lister(buf,10);
		lister(buf+taillepage,10);
		lister(buf+2*taillepage,10);
		/**Remplir la 2ème page avec 'd'*/
		garnir(buf+taillepage,taillepage,'d');
        sleep(8);
        /**Lister les 1à premiers octets de chaque page*/
        lister(buf,10);
        lister(buf+taillepage,10);
		lister(buf+2*taillepage,10);
        exit(0);
	}
    /**Pere*/
    else{
        sleep(1);
    garnir(buf,taillepage,'b');
    garnir(buf+taillepage,taillepage,'b');
    sleep(6);
    garnir(buf+taillepage,taillepage,'c');
    }
}